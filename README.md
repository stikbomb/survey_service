# Сервис для проведения опросов

## Запуск проекта
```
# Скопируйте код и перейдите в папку проекта:
git clone
cd survey_service

# Установите вирутальное окружение, активируйте его и установите необходимые зависимости:
python -m venv venv
source venv/bin/activate
pip install -r requirementx.txt

# Перейдите в папку приложения, создайте миграции и обновите базу данных:
cd survey_service
python manage.py makemigrations
python manage.py migrate

# Создайте супер-пользователя (ответьте на вопросы в консоли после выполнения команды):
pythom manage.py createsuperuser

# Запустите сервер:
python manage.py runserver
```

По умолчанию сервер запустится по адресу 127.0.0.1:8000. Если порт 8000 занят, необходимо запустить сервер на другом порту командой:

`python manage.py runserver 8998`
## Запуск проекта через Docker
```
# Скопирйте код и перейдите в папку проекта:
git clone
cd survey_service

# Запустите сборку образа Docker:
docker build -t survey_service .

# Запустите приложение:
docker run -it -p 8020:8020 survey_service3
```
По умолчанию сервер запустится по адресу 127.0.0.1:8020.
## Requirements
- Django 2.2.10
- DjangoRestFramework
- python-dotenv
- gunicorn (при запуске через Docker)
- nginx (при запуске через Docker)
## Описание проекта
### Общий принцип работы
Проект можно условно разделить на две части - создание шаблона опроса и работа с активными опросами.

Опрос считается активным, если текущая дата лежит в промежутке между датой начала опроса (beginning_data) 
и датой окончания опроса(experation_date).

Опрос состоит из вопросов. Вопросы бывают трёх типов - с возможностью выбора одного варианта из предложенных,
 с возможностью выбора нескольких вариантов из предложенных и с возможностью указания собственного варианта ответа.
У первых двух типов вопросов есть связанные варианты ответа, из которых происходит выбор.
### Создание опроса
Администратор логинится в системе и получает доступ к созданию опроса.
При создании опроса необходимо указать минимум два вопроса.
У вопросов с предопределёнными вариантами ответа должно быть указано минимум два варианта ответа.
### Прохождение опроса
Прохождение опроса анонимно, однако при сохранении пройденного опроса сохраняется уникальный ID пользователя, 
по которому можно получить все пройденные опросы, а также происходит фильтрация активных опросов.
Предусмотрена возможность получения всех активных опросов и отпросов, которые еще не проходил конкретный пользователь.

Учитывая, что активный опрос не защищён от изменения (кроме поля beginning_date), в качестве результат опроса 
сохраняется в текстовом виде без ссылок на исходные вопросы и варианты ответов.
Единственно исключение - поле `questinnaire`, которое ссылается на шаблон опроса и служит для фильтрации пройденных 
опросов по конкретному пользователю.

Приведены два возможных пути заполнения пройденных опросов.

В первом - `api/passed_surveys` - в запросе на сохранение указываются ID вопросов и вариантов ответов из шаблона запроса. 
Текстовые значения полей берутся из модели шаблона и связанных моделей.

Во втором - `api/alternative_passed_surveys` - в запросе передаются текстовые значения данных опроса, вопросов и ответов,
без ID и ссылок на модель шаблона и связанные модели.
### Ограничения
- нельзя создать опрос с числом вопросом меньшим двух;
- нельзя создать вопрос с предопределёнными ответами с числом ответом меньше двух;
- нельзя изменить тип вопроса после создания, для этого необходимо удалить старый вопрос и добавить новый;
- нельзя удалить вопрос, если после удаления у родительского опроса останется меньше двух вопросов;
- нельзя удалить вариант ответа, если тип вопроса подразумевает предопределённые варианты ответы и после удаления
останется меньше двух варинатов ответа;
- после создания нельзя поменять дату начала опроса;
- нельзя поменять дату окончания опроса на дату более раннюю, чем  начало опроса.

### Пояснение по проекту
- в некоторых местах проектах докстринги используются для пояснения неочевидной логики. Для удобства докстринги 
написаны на русском языке.
- при создании объекта используются транзакции - объект или будет создан со всему дочерничи объектами, 
или не будет создан вообще. 

### Документация
Документация к проету выполнена в Swagger'e. В корне проекта находится файл swagger.yaml, в папке swagger находятся
вложенные схемы объектов, запросов и ответов.

Для просмотра документации можно использоваться образ Docker.

```
# Из корневого каталога проекта

docker pull swaggerapi/swagger-ui

docker run --name swagger --restart always \
-p 9001:8080 -e SWAGGER_JSON=/tmp/swagger.yaml \
-e DEFAULT_MODELS_EXPAND_DEPTH=-1 \
-v $(pwd):/tmp swaggerapi/swagger-ui \
``` 

Документация будет доступна по адресу 127.0.0.1:9001.

##TODO:
- запрет на изменение даты окончания опроса на дату более раннюю, чем последние пройденный опрос;
- сортировка вопросов и вариантов ответа;
- тесты.